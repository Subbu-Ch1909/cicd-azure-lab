name: app-ci-cd
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt
          pip install pytest

      - name: Run tests
        run: pytest -q

      - name: Validate Docker build
        run: docker build -t app:test .

      - name: Warmup artifact
        run: echo "run $GITHUB_RUN_ID" > hello-${{ vars.YOURID4 }}.txt

      - uses: actions/upload-artifact@v4
        with:
          name: hello-${{ vars.YOURID4 }}
          path: hello-${{ vars.YOURID4 }}.txt

  deploy:
    needs: build-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write       # for OIDC azure/login
      contents: read
      packages: write       # needed to push to GHCR
    env:
      RG:  ${{ vars.AZURE_RESOURCE_GROUP }}
      WEB: ${{ vars.AZURE_WEBAPP_NAME }}
    steps:
      - uses: actions/checkout@v4

      # Login to Azure using OIDC, then select subscription explicitly
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Select subscription
        env:
          SID1: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          SID2: ${{ secrets.SUBSCRIPTION_ID }}  # optional fallback if you used this name
        run: |
          SUB="${SID1:-$SID2}"
          if [ -z "$SUB" ]; then
            echo "No subscription ID in AZURE_SUBSCRIPTION_ID (or SUBSCRIPTION_ID)."; exit 1
          fi
          az account set --subscription "$SUB"
          az account show -o table

      # Push image to GitHub Container Registry (GHCR)
      - name: Login to GHCR
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push image (GHCR)
        run: |
          set -euo pipefail
          TAG="${GITHUB_SHA::7}-${{ vars.YOURID4 }}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER}/labapp:${TAG}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Pushed $IMAGE"

      # Point the Web App at the GHCR image (public) and set WEBSITES_PORT
      - name: Configure Web App container (GHCR)
        run: |
          az webapp config container set \
            -g "$RG" -n "$WEB" \
            --docker-custom-image-name "$IMAGE" \
            --docker-registry-server-url "https://ghcr.io"
          az webapp config appsettings set \
            -g "$RG" -n "$WEB" \
            --settings WEBSITES_PORT=8080
          az webapp restart -g "$RG" -n "$WEB"

      - name: Show site URL
        run: |
          URL=$(az webapp show -g "$RG" -n "$WEB" --query defaultHostName -o tsv)
          echo "Site: https://$URL"
